- job-template:
    name: Carbon-NightlyTests
    concurrent: True
    node: carbon
    description: "
      A nightly job which runs all the integration tests as well as the unit tests.
      <!-- Managed by Jenkins Job Builder -->"
    logrotate:
      daysToKeep: 30
      numToKeep: 30
    parameters:
      - string:
          name: CARBON_SETTINGS
          default: /root/carbon.cfg
          description: 'location of the carbon config settings.'
    scm:
      - git:
          url: https://code.engineering.redhat.com/gerrit/p/carbon.git
          branches:
              - origin/develop
          skip-tag: True
    triggers:
      # sets time when to trigger build
      - timed: '0 1 * * *'
    builders:
      - shell: |
          set +x
          echo "**************************************************************"
          echo "Create virtual environment within workspace"
          PATH="$WORKSPACE/venv/bin:$HOME/.local/bin:/usr/local/bin:$PATH"

          if [ ! -d "venv" ]; then
              virtualenv venv
          fi

          . $WORKSPACE/venv/bin/activate
          echo $CARBON_SETTINGS
          export CARBON_SETTINGS=$CARBON_SETTINGS
          pip install -r $WORKSPACE/requirements.txt
          pip install --process-dependency-links --editable .
          rc=$?
          if [ $rc -eq 0 ]; then
              echo "*** Virtual Environment created successfully : " $rc
          else
              echo "Virtual Environment creation failed : " $rc
              echo "PITJOBSTATUS=1" >> $WORKSPACE/env.txt
              exit 1
          fi

          echo "************************************************************"
          echo " updating the tests to run"
          echo "************************************************************"

          sed -i '/run-functional-tests/c\   {{toxinidir}}/scripts/run-integration-tests' $WORKSPACE/tox.ini


          echo "*************************************************************"
          echo "PYTHON PATH : " `which python`
          echo "CARBON VERSION : " `carbon --version`
          echo "VIRTUAL ENVIRONMENT PYTHON PACKAGES :"; pip freeze
          echo "*************************************************************"

          make
          rc=$?
          if [ $rc -eq 0 ]; then
              echo "*** Carbon validation PASSED : " $rc
          else
              echo "Carbon validation FAILED : " $ rc
              echo "PITJOBSTATUS=1" >> $WORKSPACE/env.txt
              exit 1
          fi
          echo "**************************************************************"
    wrappers:
      - ansicolor
      - workspace-cleanup
    publishers:
      - archive:
          artifacts: 'tests/cover/**'
      - junit:
          results: 'tests/cover/functional/py27/nosetests.xml, tests/cover/functional/py36/nosetests.xml'
      - shining-panda:
          html-reports-directory: '**/tests/cover/**'
      - ircbot:
          strategy: any-failure
          message-type: summary-params
          channels:
            - name: '#pit-bot'

- project:
    name: Carbon-NightlyTests
    jobs:
      - Carbon-NightlyTests
