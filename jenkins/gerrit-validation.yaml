- job-template:
    name: Carbon-Validation
    concurrent: True
    node: carbon-jslave
    description: "
      A job which validates the following items below for any new code review
      for carbon project (<b>develop</b> branch):<br>
        1. Install carbon based on the latest changes<br>
        2. Successfully execute all carbon unit tests<br>
        3. Successfully verify carbon PEP8 standards are met<br>"
    logrotate:
      daysToKeep: 30
      numToKeep: 30
    scm:
      - git:
          url: ssh://qe-pit-jenkins@code.engineering.redhat.com:22/carbon
          name: ''
          refspec: 'refs/changes/*:refs/changes/*'
          credentials-id: 5ed678e3-0a20-46da-979a-4192e7523c33
          branches:
            - $GERRIT_REFSPEC
          skip-tag: True
    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event
          override-votes: True
          gerrit-build-started-verified-value: 0
          gerrit-build-successful-verified-value: 1
          gerrit-build-failed-verified-value: -1
          gerrit-build-unstable-verified-value: 0
          gerrit-build-notbuilt-verified-value: 0
          gerrit-build-started-codereview-value: 0
          gerrit-build-successful-codereview-value: 0
          gerrit-build-failed-codereview-value: 0
          gerrit-build-unstable-codereview-value: 0
          gerrit-build-notbuilt-codereview-value: 0
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'carbon'
              branches:
                - branch-compare-type: 'PLAIN'
                  branch-pattern: 'develop'
    builders:
      - shell: |
          set +x
          echo "**************************************************************"
          echo "Create virtual environment within workspace"
          PATH="$WORKSPACE/venv/bin:$HOME/.local/bin:/usr/local/bin:$PATH"

          if [ ! -d "venv" ]; then
              virtualenv venv
          fi

          . $WORKSPACE/venv/bin/activate
          pip install -r $WORKSPACE/requirements.txt
          pip install --process-dependency-links --editable .
          rc=$?
          if [ $rc -eq 0 ]; then
              echo "*** Virtual Environment created successfully : " $rc
          else
              echo "Virtual Environment creation failed : " $rc
              echo "PITJOBSTATUS=1" >> $WORKSPACE/env.txt
              exit 1
          fi

          echo "*************************************************************"
          echo "PYTHON PATH : " `which python`
          echo "CARBON VERSION : " `carbon --version`
          echo "VIRTUAL ENVIRONMENT PYTHON PACKAGES :"; pip freeze
          echo "*************************************************************"

          make
          rc=$?
          if [ $rc -eq 0 ]; then
              echo "*** Carbon validation PASSED : " $rc
          else
              echo "Carbon validation FAILED : " $ rc
              echo "PITJOBSTATUS=1" >> $WORKSPACE/env.txt
              exit 1
          fi
          echo "**************************************************************"
    wrappers:
      - ansicolor
      - workspace-cleanup
    publishers:
      - archive:
          artifacts: 'tests/cover/**'
      - junit:
          results: 'tests/cover/functional/py27/nosetests.xml, tests/cover/functional/py36/nosetests.xml'
      - shining-panda:
          html-reports-directory: '**/tests/cover/**'
      - ircbot:
          strategy: failure-and-fixed
          message-type: summary-scm
          channels:
            - name: '#pit-bot'
              notify-only: True

- project:
    name: Carbon-Validation
    jobs:
      - Carbon-Validation